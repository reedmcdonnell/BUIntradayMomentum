---
title: "IntradayMomentum"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Intraday Momentum SPY
```{r echo=FALSE, warning=FALSE}
#Clear Workspace
rm(list = ls())

#Packages
library(data.table)
library(lubridate)
library(dplyr)
library(ggplot2)
library(moments)
library(psych)
```


## Functions
```{r echo = FALSE}
#Functions
histogram <- function(x, title, varTitle) {
  std <- sd(x)
  avg <- mean(x)
  binWdth <- (max(x) - min(x)) / 100
  qplot(x,
      geom="histogram",
      binwidth=binWdth,
      xlim=c(avg - 3 * std, avg + 3 * std),
      main=title, 
      xlab=varTitle,  
      fill=I("blue"), 
      col=I("red"), 
      alpha=I(.2)) + annotate("text", label = paste0('Mean: ', signif(avg, 4), ', Std: ', signif(std, 4), '\n', 
                                                     'Kurt: ', signif(kurtosis(x), 4), ' Skew: ', signif(skewness(x), 4)),
                              x = avg - 2 * std, y = 200, size = 4, colour = "red")
}
```

## Load data
```{r echo=FALSE}
#Load minute data for SPY
load(paste0('../ConsolidatedData/', 'minuteData.Rda'))

#Fix timezone issue
attr(minuteData$Date, "tzone") <- "EST5EDT"
minuteData[, Date := Date - 60 * 60] #<- minuteData$Date - 60*60 #subratct hour

#Seperate Date and Time from POSIX for other Use
minuteData[, DATE := as.Date(Date)]
minuteData[, TIME := strftime(Date, format="%H:%M:%S")]

#Remove rows that don't have continuous price history
numOfDailyObs <- length(seq(as.POSIXct("2000-01-01 9:30:00"), as.POSIXct("2000-01-01 16:00:00"), by='min')) #390 minutes + 1 = 391 to include bounds
numOfDailyObs <- 391
minuteData <- minuteData[, if (.N == numOfDailyObs) .SD, by = (DATE)]

#Replace 9:30 Price with previous Close Price
minuteData[, c('Open', 'Close') := list(first(Price), last(Price)), by = DATE]
minuteData[, Price2 := shift(Price)]
minuteData[hour(Date) == 9 & minute(Date) == 30, Price := Price2]
minuteData <- minuteData[, Price2 := NULL]
minuteData <- na.omit(minuteData)
minuteData <- minuteData[, if (.N == numOfDailyObs) .SD, by = (DATE)]

#Calculate minute returns by day
minuteData[, Ret := Price / shift(Price) - 1, by = DATE]
minuteData[, Ret := shift(Ret, -1)]

#Group by 30 minute buckets and calculate return and volatility
bucketData <- minuteData[, .(DATE = first(DATE), TIME = first(TIME), Open = first(Open), Close = first(Close),
                             Ret = (tail(cumprod(1 + Ret), 1) - 1), Vol = sd(Ret), Size = sum(Size)), 
                         by = cut(Date, '30 min')]
names(bucketData)[1] <- 'Date'
bucketData$Date <- as.POSIXct(bucketData$Date)

#Create time group number
bucketData[, Bucket := .GRP, by = TIME]

retData <- dcast(bucketData, DATE ~ Bucket, value.var = 'Ret')
retData[, ncol(retData) := NULL]
retCols <- unlist(lapply(seq(13), function(x) paste0('R', x)))
names(retData) <- c('DATE', retCols)

volData <- dcast(bucketData, DATE ~ Bucket, value.var = 'Vol')
volData[, ncol(volData) := NULL]
volCols <- unlist(lapply(seq(13), function(x) paste0('V', x)))
names(volData) <- c('DATE', volCols)
volData[, Vol := rowMeans(.SD), by = 'DATE']

sizeData <- dcast(bucketData, DATE ~ Bucket, value.var = 'Size')
sizeData[, Size := Reduce(`+`, .SD), by = DATE]
sizeData <- sizeData[, .(DATE, Size)]

openClose <- unique(bucketData[, .(DATE, Open, Close)])

dateData <- Reduce(function (x, y) merge(x, y, by = c('DATE')), list(retData, volData, sizeData, openClose))
names(dateData)[1] <- 'Date'

data <- dateData

#Calculate average vol
```

## Preliminary data analysis
## Histograms
```{r, warning=FALSE}
histogram(data$R1, 'First 30-Minute Returns', 'R1')
describe(data$R1)
histogram(data$R13, 'Last 30-Minute Returns', 'R3')
describe(data$R13)
histogram(data$V1, 'First 30-Minute Volatility', 'Vol')
describe(data$V1)
histogram(data$V13, 'Last 30-Minute Volatility', 'Vol')
describe(data$V13)
histogram(data$Size, 'Trade Size', 'Size')
describe(data$Size)
```

## Regressions
```{r}
#R13 = B0 + B1*R1 + B2*R2 + ... + B13*R13
formula <- paste("R13 ~", paste(head(retCols, length(retCols) - 1), collapse = " + "))
model1 <- lm(formula, data = data)
summary(model1)

#R13 = B0 + B1*R1 + B2*R2 + ... + B13*R13
#formula <- paste("R13 ~", paste(head(retCols, length(retCols) - 1), collapse = " + "))
#model1 <- lm(formula, data = data)
#summary(model1)
```

## Strategies
```{r}
#Long/Short Strategy
#Predict value
data[, Strat1Signal := predict(model1)]
data[, Strat1Ret := ifelse(Strat1Signal > 0, R13, -R13)]
data[, Strat1CumRet := cumprod(1 + Strat1Ret)]

#Random Strategy
data[, RandomSignal := rbinom(.N, 1, .5)]
data[, RandomRet := ifelse(Strat1Signal == 1, R13, -R13)]
data[, RandomCumRet := cumprod(1 + RandomRet)]

#SPY Hold Strategy
data[, SPYRet := Close / shift(Close) - 1]
data[is.na(SPYRet), SPYRet := 0]
data[, SPYCumRet := cumprod(1 + SPYRet)]
```

## Plot Strategies
```{r}
#Plot strategies
plot <- ggplot() +
  geom_line(data = data, aes(x = Date, y = SPYCumRet, colour = 'SPY Long')) + 
  geom_line(data = data, aes(x = Date, y = Strat1CumRet, colour = 'Long/Short Strategy')) + 
  geom_line(data = data, aes(x = Date, y = RandomCumRet, colour = 'Random Strategy')) + 
  xlab('Dates') + ylab('Return') + ggtitle('Strategy Return')
plot(plot)
```

## Histogram of Strategy returns
```{r warning=FALSE}
histogram(data$Strat1Ret, 'Long/Short Strategy Daily Returns', 'Strat1Ret')
histogram(data$Strat1Ret - data$SPYRet, 'Excess Daily Returns', 'Excess Returns')
```

## Remove high volatility days to normalize long/short strategy returns
```{r}
temp <- data[Vol %between% c(mean(Vol) - 2*sd(Vol), mean(Vol) + 2*sd(Vol))]

#Long/Hold strategy with +/- 3 standard deviations returns ommited
temp$Strat1CumRet <- cumprod(1 + temp$Strat1Ret)

#Excess Returns
temp[, ExcessRet := Strat1Ret - SPYRet]

#Plot Long/Hold std modified strategy
plot <- ggplot() +
  geom_line(data = temp, aes(x = Date, y = SPYCumRet, colour = 'SPY Long')) + 
  geom_line(data = temp, aes(x = Date, y = Strat1CumRet, colour = 'Long/Short Strategy'))
plot(plot)

#Histogram excess returns
histogram(temp$ExcessRet, 'Long/Short Strategy Excess Returns Std Modified', 'Returns')

#Portfoli metrics
sharpe <- ((tail(temp$Strat1CumRet, 1) - tail(temp$SPYCumRet, 1)) / 14) / sd(temp$Strat1Ret - temp$SPYRet)
```

